---
environments:
  - external
tags:
  - manual-selection
---

# N08 - Verify CVE upgrades override pending install plans

## Description

This test case should verify that an existing install plan can be overridden by a CVE patch release.
More info: <https://issues.redhat.com/browse/INTLY-8747>

## Prerequisites

- `opm` installed. More info: <https://github.com/RHCloudServices/integreatly-help/blob/master/guides/olm/installing-rhmi-bundle-format.md#prerequites>
- `operator-sdk` version is at least 0.16.0
- a fresh cluster to run this test case

**Note:** The bundle format can differ between various releases of the operator-sdk. Try switching between v0.16.0, and the latest release if you experience problems.

## Steps

1. Generate the CSV for the current release (e.g. 2.5.0), publish it and install RHMI from OLM. You can follow the steps described here: <https://github.com/RHCloudServices/integreatly-help/blob/master/guides/olm/installing-rhmi-bundle-format.md#installing-rhmi-through-olm-with-bundle-format>

2. Create a CSV for a new minor version (e.g. 2.6.0):

   1. Run `SEMVER=2.6.0 ./scripts/prepare-release.sh` from the root folder of the operator

   2. Go to `deploy/olm-catalog` and run `opm alpha bundle generate -d . --channels alpha --package integreatly --output-dir bundle --default alpha` to generate the bundle

   3. Build and push the bundle for the release:

   ```bash
   $ docker build -f bundle.Dockerfile -t quay.io/<your quay user>/integreatly-bundle:2.6.0 .
   $ docker push quay.io/<your quay user>/integreatly-bundle:2.6.0
   ```

   4. Build and push the index:

   ```bash
   $ opm index add \
         --bundles quay.io/<your quay account>/integreatly-bundle:2.6.0 \
         --build-tool docker \
         --tag quay.io/<your quay account>/integreatly-index:2.6.0
   $ docker push quay.io/<your quay account>/integreatly-index:2.6.0
   ```

   5. Edit the catalog source and point it to your quay account and latest index version: `oc edit catalogsource rhmi-operators -n openshift-marketplace`

   6. Wait for OLM to update the catalog. The release should become available in the OLM catalog.

3. Verify that the RHMI operator creates an `InstallPlan` but does not approve it. Make sure the `InstallPlan` references the current (e.g. 2.5.0) release.

4. Create a CSV for a new patch version (e.g. 2.5.1):

   1. Run `SEMVER=2.6.0 ./scripts/prepare-release.sh` from the root folder of the operator

   2. Make sure that `spec.replaces` points to the previous version (e.g. 2.5.0)

   3. Add the `serviceAffecting` annotation to the generated CSV with a value of `"true"`

   4. Build and push the updated bundle as described in steps 2.2 and 2.3

   5. Build and push the index as described in step 2.4

5. Verify that the RHMI operator deletes the current `InstallPlan` and updates the subscription to the patch release (e.g. 2.5.1)

6. Verify that the patch release is automatically installed (because `serviceAffecting` was set)

7. Verify that the installation of the patch release succeeds and that the RHMI operator creates a new `InstallPlan` for the previously created minor release (e.g. 2.6.0)
